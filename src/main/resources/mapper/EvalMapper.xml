<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.Eval.EvalDAO">

    <!-- 1. ÌÖåÏä§Ìä∏Ïö© ÏøºÎ¶¨ -->
    <select id="testQuery" resultType="string">
        SELECT 'OK' AS result
    </select>

    <!-- Î∂ÄÏÑúÎ≥Ñ ‚ÄúÎã¥Îãπ ÏÇ¨Ïõê(ÏµúÏ¢ÖÎ≥ÄÍ≤ΩÏÇ¨Ïõê)‚Äù Ï°∞Ìöå -->
    <select id="getEmployeeByDept" resultType="map" parameterType="string">
        SELECT
        U.ID,
        U.INST_CD,
        U.EMP_NO,
        U.USER_NM,
        U.USER_EMAIL,
        U.MOBILE_NO,
        U.POST_CD,
        U.REAL_ENT_DT,
        D.DEPT_CD,
        D.DEPT_NM
        FROM withinfo_dev.TUSR001_USER U
        JOIN withinfo_dev.TCOM003_DEPT D
        ON U.INST_CD = D.INST_CD
        AND U.EMP_NO  = D.LST_CHG_EMP_NO   <!-- üîµ Ïó¨Í∏∞ÏÑú Í¥ÄÍ≥Ñ Îß∫Ïùå -->
        WHERE D.DEPT_CD = #{deptCd}
        ORDER BY U.ID
    </select>

    <!-- 3. Î∂ÄÏÑú Ï†ïÎ≥¥ Ìïú Í±¥ Ï°∞Ìöå -->
    <select id="getDept" resultType="map">
        SELECT
        ID,
        INST_CD,
        DEPT_CD,
        DEPT_NM,
        UPPER_DEPT_CD,
        DEPT_LVL_CD
        FROM withinfo_dev.TCOM003_DEPT
        ORDER BY ID
    </select>

    <!-- 3. Ïù∏ÏÇ¨ÌèâÍ∞Ä Îß§Ìïë -->
    <insert id="createEvalMapping" parameterType="map">
        INSERT INTO EVAL_MAPPING (
        INST_CD,
        YEAR,

        TARGET_EMP_NO,
        TARGET_DEPT_CD,
        TARGET_DUTY_CD,

        SWEAR_SUBMIT_YN,

        SELF_EVAL_YN,
        SELF_EVAL_DUE_DATE,
        SELF_EVAL_SUBMIT_YN,

        FIRST_EVALUATOR_EMP_NO,
        FIRST_EVAL_DUE_DATE,
        FIRST_EVAL_SUBMIT_YN,

        SECOND_EVALUATOR_EMP_NO,
        SECOND_EVAL_DUE_DATE,
        SECOND_EVAL_SUBMIT_YN
        )
        SELECT
        M.INST_CD,
        #{year}                                 AS YEAR,

        M.EMP_NO                                AS TARGET_EMP_NO,
        M.DEPT_CD                               AS TARGET_DEPT_CD,
        M.DUTY_CD                                AS TARGET_DUTY_CD,

        'N'                                      AS SWEAR_SUBMIT_YN,  -- ÏóÖÎ¨¥ÏÑúÏïΩÏÑú Ï†úÏ∂úÏó¨Î∂Ä(Ï¥àÍ∏∞Í∞í)

        -- ÏûêÍ∏∞ÌèâÍ∞Ä
        'Y'                                      AS SELF_EVAL_YN,
        #{selfDueDate}                           AS SELF_EVAL_DUE_DATE,
        'N'                                      AS SELF_EVAL_SUBMIT_YN,

        -- 1Ï∞® ÌèâÍ∞ÄÏûê: Î∂ÄÏÑúÏû•(DEPT_HDR_YN = 'Y')
        L1.EMP_NO                                AS FIRST_EVALUATOR_EMP_NO,
        #{firstDueDate}                          AS FIRST_EVAL_DUE_DATE,
        'N'                                      AS FIRST_EVAL_SUBMIT_YN,

        -- 2Ï∞® ÌèâÍ∞ÄÏûê: Í∞ôÏùÄ Î∂ÄÏÑú ÏÉÅÏúÑÏßÅÍ∏â Ï§ë Í∞ÄÏû• ÎÜíÏùÄ ÏÇ¨Îûå 1Î™Ö
        L2.EMP_NO                                AS SECOND_EVALUATOR_EMP_NO,
        #{secondDueDate}                         AS SECOND_EVAL_DUE_DATE,
        'N'                                      AS SECOND_EVAL_SUBMIT_YN

        FROM TCOM010_EMP_DEPT M

        -- 1Ï∞® ÌèâÍ∞ÄÏûê (Î∂ÄÏÑúÏû•)
        LEFT JOIN TCOM010_EMP_DEPT L1
        ON L1.INST_CD = M.INST_CD
        AND L1.DEPT_CD = M.DEPT_CD
        AND L1.DEPT_HDR_YN = 'Y'
        AND L1.MAIN_DEPT_YN = 'Y'

        -- 2Ï∞® ÌèâÍ∞ÄÏûê (ÏÉÅÏúÑÏßÅÍ∏â Ï§ë ÏµúÍ≥† DUTY_CD 1Î™Ö)
        LEFT JOIN TCOM010_EMP_DEPT L2
        ON L2.INST_CD = M.INST_CD
        AND L2.DEPT_CD = M.DEPT_CD
        AND L2.DUTY_CD = (
        SELECT MAX(L3.DUTY_CD)
        FROM TCOM010_EMP_DEPT L3
        WHERE L3.INST_CD = M.INST_CD
        AND L3.DEPT_CD = M.DEPT_CD
        AND L3.MAIN_DEPT_YN = 'Y'
        AND L3.DUTY_CD > M.DUTY_CD
        )
        WHERE M.MAIN_DEPT_YN = 'Y'   -- Ï£ºÎ∂ÄÏÑúÎßå ÌèâÍ∞ÄÎåÄÏÉÅ
        <if test="instCd != null and instCd != ''">
            AND M.INST_CD = #{instCd}
        </if>
        ;
    </insert>

    <delete id="deleteEvalMapping" parameterType="map">
        DELETE FROM EVAL_MAPPING
        WHERE YEAR = #{year}
        <if test="instCd != null and instCd != ''">
            AND INST_CD = #{instCd}
        </if>
    </delete>

</mapper>
