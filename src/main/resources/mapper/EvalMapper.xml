<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.Eval.EvalDAO">

    <!-- 1. 테스트용 쿼리 -->
    <select id="testQuery" resultType="string">
        SELECT 'OK' AS result
    </select>

    <!-- 부서별 “담당 사원(최종변경사원)” 조회 -->
    <select id="getEmployeeByDept" resultType="map" parameterType="string">
        SELECT
        U.ID,
        U.INST_CD,
        U.EMP_NO,
        U.USER_NM,
        U.USER_EMAIL,
        U.MOBILE_NO,
        U.POST_CD,
        U.REAL_ENT_DT,
        D.DEPT_CD,
        D.DEPT_NM
        FROM withinfo_dev.TUSR001_USER U
        JOIN withinfo_dev.TCOM010_EMP_DEPT ED
        ON U.INST_CD = ED.INST_CD
        AND U.EMP_NO  = ED.EMP_NO
        JOIN withinfo_dev.TCOM003_DEPT D
        ON ED.INST_CD = D.INST_CD
        AND ED.DEPT_CD = D.DEPT_CD
        WHERE D.DEPT_CD = #{deptCd}
        ORDER BY U.ID;
    </select>

    <!-- 3. 부서 정보 한 건 조회 -->
    <select id="getDept" resultType="map">
        SELECT
        ID,
        INST_CD,
        DEPT_CD,
        DEPT_NM,
        UPPER_DEPT_CD,
        DEPT_LVL_CD
        FROM withinfo_dev.TCOM003_DEPT
        ORDER BY ID
    </select>

    <!-- 3. 인사평가 매핑 -->
    <insert id="createEvalMapping" parameterType="map">
        <![CDATA[
    INSERT INTO withinfo_dev.EVAL_MAPPING (
        INST_CD,
        YEAR,

        TARGET_EMP_NO,
        TARGET_DEPT_CD,
        TARGET_DUTY_CD,

        SWEAR_SUBMIT_YN,

        SELF_EVAL_YN,
        SELF_EVAL_DUE_DATE,
        SELF_EVAL_SUBMIT_YN,

        FIRST_EVALUATOR_EMP_NO,
        FIRST_EVAL_DUE_DATE,
        FIRST_EVAL_SUBMIT_YN,

        SECOND_EVALUATOR_EMP_NO,
        SECOND_EVAL_DUE_DATE,
        SECOND_EVAL_SUBMIT_YN
    )
    SELECT
        M.INST_CD,
        #{year}                             AS YEAR,

        M.EMP_NO                            AS TARGET_EMP_NO,
        M.DEPT_CD                           AS TARGET_DEPT_CD,
        M.DUTY_CD                           AS TARGET_DUTY_CD,

        'N'                                 AS SWEAR_SUBMIT_YN,       -- 업무서약서 제출여부(초기값)

        -- 자기평가
        'Y'                                 AS SELF_EVAL_YN,
        #{selfDueDate}                      AS SELF_EVAL_DUE_DATE,
        'N'                                 AS SELF_EVAL_SUBMIT_YN,

        -- 1차 평가자
        CASE
            WHEN M.DEPT_HDR_YN = 'Y'
                THEN PHD.EMP_NO             -- 내가 부서장이면 상위 부서장
            ELSE CHD.EMP_NO                 -- 팀원/구성원이면 현재 부서장
        END                                 AS FIRST_EVALUATOR_EMP_NO,
        #{firstDueDate}                     AS FIRST_EVAL_DUE_DATE,
        'N'                                 AS FIRST_EVAL_SUBMIT_YN,

        -- 2차 평가자
        CASE
            WHEN M.DEPT_HDR_YN = 'Y'
                THEN COALESCE(GHD.EMP_NO, PHD.EMP_NO)  -- 부서장이면 상위의 상위 부서장(없으면 상위 부서장)
            ELSE PHD.EMP_NO                           -- 팀원/구성원이면 상위 부서장
        END                                 AS SECOND_EVALUATOR_EMP_NO,
        #{secondDueDate}                    AS SECOND_EVAL_DUE_DATE,
        'N'                                 AS SECOND_EVAL_SUBMIT_YN
    FROM withinfo_dev.TCOM010_EMP_DEPT M

    -- 부서 정보 (현재 부서)
    JOIN withinfo_dev.TCOM003_DEPT D
      ON D.INST_CD = M.INST_CD
     AND D.DEPT_CD = M.DEPT_CD

    -- 상위 부서 정보
    LEFT JOIN withinfo_dev.TCOM003_DEPT PD
      ON PD.INST_CD = D.INST_CD
     AND PD.DEPT_CD = D.UPPER_DEPT_CD

    -- 상위의 상위 부서 정보
    LEFT JOIN withinfo_dev.TCOM003_DEPT GD
      ON GD.INST_CD = PD.INST_CD
     AND GD.DEPT_CD = PD.UPPER_DEPT_CD

    -- 현재 부서장 (팀장/실장 등)
    LEFT JOIN withinfo_dev.TCOM010_EMP_DEPT CHD
      ON CHD.INST_CD     = M.INST_CD
     AND CHD.DEPT_CD     = M.DEPT_CD
     AND CHD.MAIN_DEPT_YN = 'Y'
     AND CHD.DEPT_HDR_YN = 'Y'

    -- 상위 부서장 (사업부장, 본부장 등)
    LEFT JOIN withinfo_dev.TCOM010_EMP_DEPT PHD
      ON PHD.INST_CD      = PD.INST_CD
     AND PHD.DEPT_CD      = PD.DEPT_CD
     AND PHD.MAIN_DEPT_YN = 'Y'
     AND PHD.DEPT_HDR_YN  = 'Y'

    -- 상위의 상위 부서장 (부사장/더 위 레벨)
    LEFT JOIN withinfo_dev.TCOM010_EMP_DEPT GHD
      ON GHD.INST_CD      = GD.INST_CD
     AND GHD.DEPT_CD      = GD.DEPT_CD
     AND GHD.MAIN_DEPT_YN = 'Y'
     AND GHD.DEPT_HDR_YN  = 'Y'

    WHERE 1 = 1
      -- 주부서만 평가대상
      AND M.MAIN_DEPT_YN = 'Y'
      -- 예: 전무/부사장 등 최상위 직급은 평가대상에서 제외 (DUTY_CD >= '70' 가정)
      AND (M.DUTY_CD < '70' OR M.DUTY_CD IS NULL)
    ]]>
        <if test="instCd != null and instCd != ''">
            AND M.INST_CD = #{instCd}
        </if>
    </insert>


    <delete id="deleteEvalMapping" parameterType="map">
        DELETE FROM withinfo_dev.EVAL_MAPPING
        WHERE YEAR = #{year}
        <if test="instCd != null and instCd != ''">
            AND INST_CD = #{instCd}
        </if>
    </delete>

    <!-- 평가 매핑 조회 -->
    <select id="getEvalMapping" parameterType="map" resultType="map">
        <![CDATA[
    SELECT
        EM.ID,
        EM.INST_CD,
        EM.YEAR,

        -- 피평가자
        EM.TARGET_EMP_NO,
        TU.USER_NM          AS TARGET_USER_NM,
        EM.TARGET_DEPT_CD,
        TD.DEPT_NM          AS TARGET_DEPT_NM,
        EM.TARGET_DUTY_CD,

        -- 업무서약서
        EM.SWEAR_SUBMIT_YN,

        -- 자기평가
        EM.SELF_EVAL_YN,
        EM.SELF_EVAL_DUE_DATE,
        EM.SELF_EVAL_SUBMIT_YN,

        -- 1차 평가
        EM.FIRST_EVALUATOR_EMP_NO,
        FU.USER_NM          AS FIRST_EVALUATOR_USER_NM,
        EM.FIRST_EVAL_DUE_DATE,
        EM.FIRST_EVAL_SUBMIT_YN,

        -- 2차 평가
        EM.SECOND_EVALUATOR_EMP_NO,
        SU.USER_NM          AS SECOND_EVALUATOR_USER_NM,
        EM.SECOND_EVAL_DUE_DATE,
        EM.SECOND_EVAL_SUBMIT_YN,

        EM.REG_DATE,
        EM.MOD_DATE
    FROM withinfo_dev.EVAL_MAPPING EM
        -- 피평가자 정보
        LEFT JOIN withinfo_dev.TUSR001_USER TU
            ON TU.INST_CD = EM.INST_CD
           AND TU.EMP_NO  = EM.TARGET_EMP_NO

        -- 1차 평가자 정보
        LEFT JOIN withinfo_dev.TUSR001_USER FU
            ON FU.INST_CD = EM.INST_CD
           AND FU.EMP_NO  = EM.FIRST_EVALUATOR_EMP_NO

        -- 2차 평가자 정보
        LEFT JOIN withinfo_dev.TUSR001_USER SU
            ON SU.INST_CD = EM.INST_CD
           AND SU.EMP_NO  = EM.SECOND_EVALUATOR_EMP_NO

        -- 부서 정보
        LEFT JOIN withinfo_dev.TCOM003_DEPT TD
            ON TD.INST_CD = EM.INST_CD
           AND TD.DEPT_CD = EM.TARGET_DEPT_CD

    WHERE 1 = 1
]]>
        <if test="instCd != null and instCd != ''">
            AND EM.INST_CD = #{instCd}
        </if>

        <if test="year != null and year != ''">
            <![CDATA[
        AND EM.YEAR = #{year}
        ]]>
        </if>

        <if test="deptCd != null and deptCd != ''">
            <![CDATA[
        AND EM.TARGET_DEPT_CD = #{deptCd}
        ]]>
        </if>

        <if test="targetEmpNo != null and targetEmpNo != ''">
            <![CDATA[
        AND EM.TARGET_EMP_NO = #{targetEmpNo}
        ]]>
        </if>

        <if test="evaluatorEmpNo != null and evaluatorEmpNo != ''">
            <![CDATA[
        AND (
              EM.FIRST_EVALUATOR_EMP_NO  = #{evaluatorEmpNo}
           OR EM.SECOND_EVALUATOR_EMP_NO = #{evaluatorEmpNo}
        )
        ]]>
        </if>

        <![CDATA[
    ORDER BY
        EM.TARGET_DEPT_CD,
        EM.TARGET_DUTY_CD,
        EM.TARGET_EMP_NO
]]>
    </select>

</mapper>
