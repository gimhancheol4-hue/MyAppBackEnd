<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.Eval.EvalDAO">

    <!-- 1. 테스트용 쿼리 -->
    <select id="testQuery" resultType="string">
        SELECT 'OK' AS result
    </select>

    <!-- 부서별 “담당 사원(최종변경사원)” 조회 -->
    <select id="getEmployeeByDept" resultType="map" parameterType="string">
        SELECT
        U.ID,
        U.INST_CD,
        U.EMP_NO,
        U.USER_NM,
        U.USER_EMAIL,
        U.MOBILE_NO,
        U.POST_CD,
        U.REAL_ENT_DT,
        D.DEPT_CD,
        D.DEPT_NM
        FROM withinfo_dev.TUSR001_USER U
        JOIN withinfo_dev.TCOM010_EMP_DEPT ED
        ON U.INST_CD = ED.INST_CD
        AND U.EMP_NO  = ED.EMP_NO
        JOIN withinfo_dev.TCOM003_DEPT D
        ON ED.INST_CD = D.INST_CD
        AND ED.DEPT_CD = D.DEPT_CD
        WHERE D.DEPT_CD = #{deptCd}
        ORDER BY U.ID;
    </select>

    <!-- 3. 부서 정보 한 건 조회 -->
    <select id="getDept" resultType="map">
        SELECT
        ID,
        INST_CD,
        DEPT_CD,
        DEPT_NM,
        UPPER_DEPT_CD,
        DEPT_LVL_CD
        FROM withinfo_dev.TCOM003_DEPT
        ORDER BY ID
    </select>

    <!-- 인사평가 매핑 생성 (우리 회사 사용자/부서 구조 기반) -->
    <insert id="createEvalMapping" parameterType="map">
        <![CDATA[
    INSERT INTO withinfo_dev.EVAL_MAPPING (
        INST_CD,
        YEAR,

        TARGET_EMP_NO,
        TARGET_DEPT_CD,
        TARGET_DUTY_CD,


        SELF_EVAL_YN,
        SELF_EVAL_DUE_DATE,
        SELF_EVAL_SUBMIT_YN,

        FIRST_EVALUATOR_EMP_NO,
        FIRST_EVAL_DUE_DATE,
        FIRST_EVAL_SUBMIT_YN,

        SECOND_EVALUATOR_EMP_NO,
        SECOND_EVAL_DUE_DATE,
        SECOND_EVAL_SUBMIT_YN
    )
    SELECT
        X.INST_CD,
    ]]>
        #{year} <![CDATA[                         AS YEAR,

        X.TARGET_EMP_NO,
        X.TARGET_DEPT_CD,
        X.TARGET_DUTY_CD,

        'Y'                                       AS SELF_EVAL_YN,
    ]]>
        #{selfDueDate} <![CDATA[                  AS SELF_EVAL_DUE_DATE,
        'N'                                       AS SELF_EVAL_SUBMIT_YN,

        X.FIRST_EVALUATOR_EMP_NO,
    ]]>
        #{firstDueDate} <![CDATA[                 AS FIRST_EVAL_DUE_DATE,
        'N'                                       AS FIRST_EVAL_SUBMIT_YN,

        -- 2차 평가자: 1차와 같으면 NULL 처리
        CASE
            WHEN X.SECOND_EVAL_CANDIDATE_EMP_NO IS NOT NULL
             AND X.SECOND_EVAL_CANDIDATE_EMP_NO != X.FIRST_EVALUATOR_EMP_NO
                THEN X.SECOND_EVAL_CANDIDATE_EMP_NO
            ELSE NULL
        END                                       AS SECOND_EVALUATOR_EMP_NO,
    ]]>
        #{secondDueDate} <![CDATA[                AS SECOND_EVAL_DUE_DATE,
        'N'                                       AS SECOND_EVAL_SUBMIT_YN
    FROM (
        SELECT
            B.INST_CD,
            B.TARGET_EMP_NO,
            B.TARGET_DEPT_CD,
            B.TARGET_DUTY_CD,
            B.FIRST_EVALUATOR_EMP_NO,
            B.SECOND_EVAL_CANDIDATE_EMP_NO,
            ROW_NUMBER() OVER (
                PARTITION BY B.INST_CD, B.TARGET_EMP_NO
                ORDER BY B.TARGET_DEPT_CD
            ) AS RN
        FROM (
            SELECT
                A.INST_CD,
                A.EMP_NO        AS TARGET_EMP_NO,
                C.DEPT_CD       AS TARGET_DEPT_CD,
                A.POST_CD       AS TARGET_DUTY_CD,

                -- ✅ 1차 평가자 계산
                CASE
                    WHEN C.DEPT_HDR_YN = 'Y'
                        THEN PHD.EMP_NO             -- 내가 부서장이면 상위 부서장
                    ELSE
                        COALESCE(CHD.EMP_NO, PHD.EMP_NO)  -- 팀원: 현재 부서장, 없으면 상위 부서장
                END         AS FIRST_EVALUATOR_EMP_NO,

                -- ✅ 2차 평가자 "후보" 계산
                CASE
                    WHEN C.DEPT_HDR_YN = 'Y' THEN
                        -- 부서장인 경우: 상위의 상위 부서장 있으면 그 사람, 없으면 NULL
                        CASE
                            WHEN GHD.EMP_NO IS NOT NULL THEN GHD.EMP_NO
                            ELSE NULL
                        END
                    ELSE
                        -- 팀원인 경우
                        CASE
                            WHEN CHD.EMP_NO IS NOT NULL THEN
                                -- 팀장 존재: 1차 = CHD, 2차 = PHD (상위 부서장)
                                PHD.EMP_NO
                            ELSE
                                -- 팀장 없음: 1차 = PHD, 2차 = 상위의 상위(GHD) 있으면 GHD, 없으면 NULL
                                CASE
                                    WHEN GHD.EMP_NO IS NOT NULL THEN GHD.EMP_NO
                                    ELSE NULL
                                END
                        END
                END         AS SECOND_EVAL_CANDIDATE_EMP_NO

            FROM withinfo_dev.TUSR001_USER A

            -- 메인부서 매핑
            LEFT JOIN withinfo_dev.TCOM010_EMP_DEPT C
              ON A.INST_CD = C.INST_CD
             AND A.EMP_NO = C.EMP_NO
             AND C.MAIN_DEPT_YN = 'Y'

            -- 현재 부서 정보
            LEFT JOIN withinfo_dev.TCOM003_DEPT D
              ON D.INST_CD = C.INST_CD
             AND D.DEPT_CD = C.DEPT_CD

            -- 상위 부서 정보
            LEFT JOIN withinfo_dev.TCOM003_DEPT PD
              ON PD.INST_CD = D.INST_CD
             AND PD.DEPT_CD = D.UPPER_DEPT_CD

            -- 상위의 상위 부서 정보
            LEFT JOIN withinfo_dev.TCOM003_DEPT GD
              ON GD.INST_CD = PD.INST_CD
             AND GD.DEPT_CD = PD.UPPER_DEPT_CD

            -- 현재 부서장
            LEFT JOIN withinfo_dev.TCOM010_EMP_DEPT CHD
              ON CHD.INST_CD      = C.INST_CD
             AND CHD.DEPT_CD      = C.DEPT_CD
             AND CHD.MAIN_DEPT_YN = 'Y'
             AND CHD.DEPT_HDR_YN  = 'Y'

            -- 상위 부서장
            LEFT JOIN withinfo_dev.TCOM010_EMP_DEPT PHD
              ON PHD.INST_CD      = PD.INST_CD
             AND PHD.DEPT_CD      = PD.DEPT_CD
             AND PHD.MAIN_DEPT_YN = 'Y'
             AND PHD.DEPT_HDR_YN  = 'Y'

            -- 상위의 상위 부서장
            LEFT JOIN withinfo_dev.TCOM010_EMP_DEPT GHD
              ON GHD.INST_CD      = GD.INST_CD
             AND GHD.DEPT_CD      = GD.DEPT_CD
             AND GHD.MAIN_DEPT_YN = 'Y'
             AND GHD.DEPT_HDR_YN  = 'Y'

            WHERE 1 = 1
    ]]>
        <if test="instCd != null and instCd != ''">
            <![CDATA[
              AND A.INST_CD = #{instCd}
            ]]>
        </if>
        <if test="userStCd != null and userStCd != ''">
            <![CDATA[
              AND A.USER_ST_CD = #{userStCd}
            ]]>
        </if>
        <![CDATA[
        ) B
    ) X
    WHERE X.RN = 1
    ;
    ]]>
    </insert>



    <delete id="deleteEvalMapping" parameterType="map">
        DELETE FROM withinfo_dev.EVAL_MAPPING
        WHERE YEAR = #{year}
        <if test="instCd != null and instCd != ''">
            AND INST_CD = #{instCd}
        </if>
    </delete>

    <!-- 평가 매핑 조회 -->
    <select id="getEvalMapping" parameterType="map" resultType="map">
        <![CDATA[
    SELECT
        EM.ID,
        EM.INST_CD,
        EM.YEAR,

        -- 피평가자
        EM.TARGET_EMP_NO,
        TU.USER_NM          AS TARGET_USER_NM,
        EM.TARGET_DEPT_CD,
        TD.DEPT_NM          AS TARGET_DEPT_NM,
        EM.TARGET_DUTY_CD,

        -- 업무서약서: eval_data 존재 여부로 완료 여부 판단
        CASE
            WHEN WP.TARGET_EMP_NO IS NOT NULL THEN 'Y'
            ELSE 'N'
        END AS SWEAR_SUBMIT_YN,

        -- 자기평가 (추후 eval_data 기준으로 바꾸고 싶으면 동일 패턴으로 변경)
        EM.SELF_EVAL_YN,
        EM.SELF_EVAL_DUE_DATE,
        EM.SELF_EVAL_SUBMIT_YN,

        -- 1차 평가
        EM.FIRST_EVALUATOR_EMP_NO,
        FU.USER_NM          AS FIRST_EVALUATOR_USER_NM,
        EM.FIRST_EVAL_DUE_DATE,
        EM.FIRST_EVAL_SUBMIT_YN,

        -- 2차 평가
        EM.SECOND_EVALUATOR_EMP_NO,
        SU.USER_NM          AS SECOND_EVALUATOR_USER_NM,
        EM.SECOND_EVAL_DUE_DATE,
        EM.SECOND_EVAL_SUBMIT_YN,

        EM.REG_DATE,
        EM.MOD_DATE
    FROM withinfo_dev.EVAL_MAPPING EM
        -- 피평가자 정보
        LEFT JOIN withinfo_dev.TUSR001_USER TU
            ON TU.INST_CD = EM.INST_CD
           AND TU.EMP_NO  = EM.TARGET_EMP_NO

        -- 1차 평가자 정보
        LEFT JOIN withinfo_dev.TUSR001_USER FU
            ON FU.INST_CD = EM.INST_CD
           AND FU.EMP_NO  = EM.FIRST_EVALUATOR_EMP_NO

        -- 2차 평가자 정보
        LEFT JOIN withinfo_dev.TUSR001_USER SU
            ON SU.INST_CD = EM.INST_CD
           AND SU.EMP_NO  = EM.SECOND_EVALUATOR_EMP_NO

        -- 부서 정보
        LEFT JOIN withinfo_dev.TCOM003_DEPT TD
            ON TD.INST_CD = EM.INST_CD
           AND TD.DEPT_CD = EM.TARGET_DEPT_CD

        -- ✅ 업무서약서 제출 여부: eval_data 기준
        LEFT JOIN (
            SELECT DISTINCT
                INST_CD,
                YEAR,
                TARGET_EMP_NO
            FROM withinfo_dev.eval_data
            WHERE eval_form_code = 'WORK_PLEDGE'
              AND eval_step      = 'PLEDGE'
              AND submit_yn      = 'Y'
        ) WP
            ON WP.INST_CD      = EM.INST_CD
           AND WP.YEAR         = EM.YEAR
           AND WP.TARGET_EMP_NO = EM.TARGET_EMP_NO

    WHERE 1 = 1
    ]]>
        <if test="instCd != null and instCd != ''">
            AND EM.INST_CD = #{instCd}
        </if>

        <if test="year != null and year != ''">
            <![CDATA[
            AND EM.YEAR = #{year}
            ]]>
        </if>

        <if test="deptCd != null and deptCd != ''">
            <![CDATA[
            AND EM.TARGET_DEPT_CD = #{deptCd}
            ]]>
        </if>

        <if test="targetEmpNo != null and targetEmpNo != ''">
            <![CDATA[
            AND EM.TARGET_EMP_NO = #{targetEmpNo}
            ]]>
        </if>

        <if test="evaluatorEmpNo != null and evaluatorEmpNo != ''">
            <![CDATA[
            AND (
                  EM.FIRST_EVALUATOR_EMP_NO  = #{evaluatorEmpNo}
               OR EM.SECOND_EVALUATOR_EMP_NO = #{evaluatorEmpNo}
            )
            ]]>
        </if>

        <![CDATA[
    ORDER BY
        EM.TARGET_DEPT_CD,
        EM.TARGET_DUTY_CD,
        EM.TARGET_EMP_NO
    ]]>
    </select>


    <!-- 문서 종류 목록 조회 -->
    <select id="getEvalForms" parameterType="map" resultType="map">
        SELECT
        l.eval_form_code AS formCode,
        l.eval_form_name AS formName
        FROM withinfo_dev.eval_layout l
        WHERE l.active_yn = 'Y'
        GROUP BY l.eval_form_code, l.eval_form_name
        ORDER BY l.eval_form_code
    </select>
    <!-- 문서 레이아웃(필드 목록) 조회 -->
    <select id="getEvalLayout" parameterType="map" resultType="map">
        SELECT
        layout_id      AS layoutId,
        eval_form_code AS formCode,
        eval_form_name AS formName,
        layout_ver     AS layoutVer,
        active_yn      AS activeYn,
        field_code     AS fieldCode,
        field_label    AS fieldLabel,
        field_type     AS fieldType,
        required_yn    AS requiredYn,
        max_length     AS maxLength,
        sort_order     AS sortOrder,
        section_name   AS sectionName,
        default_value  AS defaultValue,
        options_json   AS optionsJson
        FROM eval_layout
        WHERE withinfo_dev.eval_form_code = #{formCode}
        AND layout_ver     = #{layoutVer}
        AND active_yn      = 'Y'
        ORDER BY sort_order, layout_id
    </select>



</mapper>
